# 预配置数据源功能使用说明

## 功能概述

本项目现在支持两种类型的数据源：
1. **用户上传的文件**：CSV、Excel、SQLite数据库文件
2. **预配置数据源**：通过环境变量配置的PostgreSQL数据库连接

## 预配置数据源特点

- **一键连接**：点击按钮即可连接到预配置的数据库
- **环境变量配置**：通过环境变量管理数据库连接信息
- **企业级数据源**：适合连接到企业的生产数据库
- **安全性**：敏感信息通过环境变量管理，不暴露在代码中

## 配置步骤

### 1. 环境变量配置

在 `.env` 文件中添加PostgreSQL数据库配置：

```env
# PostgreSQL预配置数据源配置（用于欧莱雅官方销售数据）
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_USER=postgres
POSTGRES_PASSWORD=your_postgres_password
POSTGRES_DATABASE=loreal_sales
```

### 2. 数据库准备

确保PostgreSQL数据库已安装并运行，且包含相关的销售数据表。

### 3. 依赖安装

确保安装了PostgreSQL驱动：

```bash
pip install psycopg2-binary
```

## 使用方法

### 前端界面

1. **预配置数据源按钮**：
   - 位于左侧数据源区域顶部
   - 显示为带有渐变背景的按钮
   - 包含数据库图标、名称和类型标识

2. **点击连接**：
   - 点击"欧莱雅官方销售数据"按钮
   - 系统自动连接到配置的PostgreSQL数据库
   - 连接成功后按钮变为选中状态

3. **开始对话**：
   - 连接成功后，聊天功能自动启用
   - 可以开始询问数据相关问题

### 后端处理流程

1. **数据源识别**：系统识别预配置数据源类型
2. **连接配置解析**：从数据库记录中读取连接配置
3. **数据库连接**：使用SQLAgent连接到PostgreSQL
4. **智能体协作**：多个Agent协同处理用户查询

## 技术实现

### 数据库模型更新

```python
class DataSource(Base):
    id = Column(Integer, primary_key=True)
    name = Column(String(255))
    file_type = Column(String(50))  # 支持 "postgres"
    is_predefined = Column(Integer, default=0)  # 1表示预配置
    connection_config = Column(Text)  # JSON格式的连接配置
    file_path = Column(String(500), nullable=True)  # 预配置数据源可为空
```

### API响应格式

```json
{
  "id": 1,
  "name": "欧莱雅官方销售数据",
  "file_type": "postgres",
  "is_predefined": true,
  "description": "连接到欧莱雅官方PostgreSQL数据库"
}
```

## 扩展性

### 添加新的预配置数据源

1. 修改 `app/scripts/init_predefined_datasources.py`
2. 添加新的数据源配置
3. 更新环境变量
4. 重启应用

### 支持其他数据库类型

1. 更新 `SQLAgent` 的连接逻辑
2. 添加相应的数据库驱动依赖
3. 更新前端显示逻辑

## 安全注意事项

1. **环境变量保护**：确保 `.env` 文件不被提交到版本控制
2. **数据库权限**：为应用创建专用的数据库用户，限制权限
3. **网络安全**：在生产环境中使用SSL连接
4. **访问控制**：考虑添加用户认证和授权机制

## 故障排除

### 常见问题

1. **连接失败**：
   - 检查环境变量配置
   - 确认数据库服务运行状态
   - 验证网络连接

2. **权限错误**：
   - 检查数据库用户权限
   - 确认数据库访问策略

3. **数据查询失败**：
   - 检查表结构是否正确
   - 验证SQL语法兼容性

### 日志查看

系统会记录详细的连接和查询日志，可以通过以下方式查看：

```bash
# 查看应用日志
tail -f logs/app.log

# 查看数据库连接日志
grep "数据库连接" logs/app.log
```

## 未来改进

1. **多数据库支持**：支持连接多个不同的预配置数据库
2. **动态配置**：通过管理界面动态添加和管理数据源
3. **连接池**：优化数据库连接性能
4. **监控告警**：添加数据库连接状态监控
